services:
  # AI Orchestrator - Central coordination
  ai-orchestrator:
    image: python:3.11-slim
    container_name: statex_ai_orchestrator_dev
    env_file:
      - ../.env
    volumes:
      - ./services/ai-orchestrator:/app
      - ./shared:/app/shared:ro
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}"
    ports:
      - "${AI_ORCHESTRATOR_EXTERNAL_PORT}:${AI_ORCHESTRATOR_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@host.docker.internal:${RABBITMQ_PORT}
      - NLP_SERVICE_URL=http://nlp-service:${NLP_SERVICE_INTERNAL_PORT:-8011}
      - ASR_SERVICE_URL=http://asr-service:${ASR_SERVICE_INTERNAL_PORT:-8012}
      - DOCUMENT_AI_URL=http://document-ai:${DOCUMENT_AI_INTERNAL_PORT:-8013}
      - PROTOTYPE_GENERATOR_URL=http://prototype-generator:${PROTOTYPE_GENERATOR_INTERNAL_PORT:-8000}
      - TEMPLATE_REPOSITORY_URL=http://template-repository:${TEMPLATE_REPOSITORY_INTERNAL_PORT:-8015}
      - FREE_AI_SERVICE_URL=http://free-ai-service:${FREE_AI_SERVICE_INTERNAL_PORT:-8016}
      - AI_WORKERS_URL=http://ai-workers:${AI_WORKERS_INTERNAL_PORT:-8017}
      - NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL:-https://notifications.statex.cz}
      - SUBMISSION_SERVICE_URL=http://submission-service:${SUBMISSION_SERVICE_INTERNAL_PORT:-8000}
      - USE_MULTI_AGENT_WORKFLOW=true
      - UPLOAD_DIR=${UPLOAD_DIR}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # NLP Service - Text analysis and generation
  nlp-service:
    image: python:3.11-slim
    container_name: statex_nlp_dev
    env_file:
      - ../.env
    volumes:
      - ./services/nlp-service:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${NLP_SERVICE_INTERNAL_PORT:-8011}"
    ports:
      - "${NLP_SERVICE_EXTERNAL_PORT}:${NLP_SERVICE_INTERNAL_PORT}"
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${NLP_SERVICE_INTERNAL_PORT:-8011}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ASR Service - Speech-to-text conversion
  asr-service:
    image: python:3.11-slim
    container_name: statex_asr_dev
    env_file:
      - ../.env
    volumes:
      - ./services/asr-service:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${ASR_SERVICE_INTERNAL_PORT:-8012}"
    ports:
      - "${ASR_SERVICE_EXTERNAL_PORT}:${ASR_SERVICE_INTERNAL_PORT}"
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      - S3_ENDPOINT=http://host.docker.internal:${MINIO_INTERNAL_PORT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${ASR_SERVICE_INTERNAL_PORT:-8012}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Document AI Service - File analysis and processing
  document-ai:
    image: python:3.11-slim
    container_name: statex_document_ai_dev
    env_file:
      - ../.env
    volumes:
      - ./services/document-ai:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${DOCUMENT_AI_INTERNAL_PORT:-8013}"
    ports:
      - "${DOCUMENT_AI_EXTERNAL_PORT}:${DOCUMENT_AI_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      - S3_ENDPOINT=http://host.docker.internal:${MINIO_INTERNAL_PORT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${DOCUMENT_AI_INTERNAL_PORT:-8013}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Prototype Generator Service
  prototype-generator:
    image: python:3.11-slim
    container_name: statex_prototype_generator_dev
    env_file:
      - ../.env
    volumes:
      - ./services/prototype-generator:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${PROTOTYPE_GENERATOR_INTERNAL_PORT:-8000}"
    ports:
      - "${PROTOTYPE_GENERATOR_PORT}:${PROTOTYPE_GENERATOR_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      - TEMPLATE_REPOSITORY_URL=http://host.docker.internal:${TEMPLATE_REPOSITORY_INTERNAL_PORT:-8015}
      - DEPLOYMENT_URL=${DEPLOYMENT_URL:-http://localhost:${FRONTEND_PORT:-3602}}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PROTOTYPE_GENERATOR_INTERNAL_PORT:-8000}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Template Repository Service
  template-repository:
    image: python:3.11-slim
    container_name: statex_template_repo_dev
    env_file:
      - ../.env
    volumes:
      - ./services/template-repository:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${TEMPLATE_REPOSITORY_INTERNAL_PORT:-8015}"
    ports:
      - "${TEMPLATE_REPOSITORY_PORT}:${TEMPLATE_REPOSITORY_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      - GIT_REPO_URL=${TEMPLATE_GIT_REPO}
      - S3_ENDPOINT=http://host.docker.internal:${MINIO_INTERNAL_PORT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${TEMPLATE_REPOSITORY_INTERNAL_PORT:-8015}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Free AI Service - Free AI models (Ollama, Hugging Face)
  free-ai-service:
    image: python:3.11-slim
    container_name: statex_free_ai_dev
    env_file:
      - ../.env
    volumes:
      - ./services/free-ai-service:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${FREE_AI_SERVICE_INTERNAL_PORT:-8016}"
    ports:
      - "${FREE_AI_SERVICE_EXTERNAL_PORT}:${FREE_AI_SERVICE_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      # - OLLAMA_URL=http://host.docker.internal:11434  # Ollama disabled
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_API_BASE=${OPENROUTER_API_BASE:-https://openrouter.ai/api/v1}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-google/gemini-2.0-flash-exp:free}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FREE_AI_SERVICE_INTERNAL_PORT:-8016}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # AI Workers - AI processing agents
  ai-workers:
    image: python:3.11-slim
    container_name: statex_ai_workers_dev
    env_file:
      - ../.env
    volumes:
      - ./services/ai-workers:/app
      - ~/.cache/pip:/root/.cache/pip
    working_dir: /app
    command: sh -c "apt-get update && apt-get install -y curl && pip install -r requirements.txt && uvicorn app.main:app --reload --host 0.0.0.0 --port ${AI_WORKERS_INTERNAL_PORT:-8017}"
    ports:
      - "${AI_WORKERS_EXTERNAL_PORT}:${AI_WORKERS_INTERNAL_PORT}"
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:${POSTGRES_PORT}/${POSTGRES_DB}
      - REDIS_URL=redis://host.docker.internal:${REDIS_PORT}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@host.docker.internal:${RABBITMQ_PORT}
      - AI_ORCHESTRATOR_URL=${AI_ORCHESTRATOR_URL:-http://ai-orchestrator:${AI_ORCHESTRATOR_INTERNAL_PORT:-8010}}
      - S3_ENDPOINT=http://host.docker.internal:${MINIO_INTERNAL_PORT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
    networks:
      - statex_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${AI_WORKERS_INTERNAL_PORT:-8017}/health"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  statex_network:
    external: true

